pipeline {
    agent any

    triggers {
        cron('H/5 * * * *') // Ejecutar cada 5 minutos
    }

    environment {
        MONGO_URI = credentials('b2eada42-2521-45e0-8f40-072912c52410')  // Configura en Jenkins
        DATABASE_NAME = 'middleware'
    }

    stages {
        stage('Preparar entorno') {
            steps {
                sh 'python3 -m venv venv'
                sh './venv/bin/pip install -r requirements.txt'
            }
        }

        stage('Ejecutar extracción') {
            steps {
                sh './venv/bin/python extract_loans.py'
            }
        }
    }

    post {
        success {
            echo "✅ Reporte generado y guardado en el workspace"
        }
        failure {
            echo "❌ Error en la extracción"
        }
    }
}
